<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Encrypt and decrypt files using AES-256 encryption with password protection">
    <title>File Encryption Tool</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .mode-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        .mode-btn.active {
            background: #dc143c;
            color: white;
            border-color: #dc143c;
        }
        .mode-btn:hover:not(.active) {
            background: #e9ecef;
        }

        .file-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 400px;
        }
        .file-input {
            display: none;
        }
        .file-input-label {
            display: block;
            padding: 20px;
            background: #dc143c;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px dashed #dc143c;
        }
        .file-input-label:hover {
            background: #b22222;
            transform: scale(1.02);
        }
        .file-input-label.drag-over {
            background: #28a745;
            border-color: #28a745;
        }
        .file-name {
            margin-top: 15px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .password-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .password-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .password-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        .password-input {
            flex: 1;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .password-input:focus {
            outline: none;
            border-color: #dc143c;
        }
        .show-password-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        .show-password-btn:hover {
            background: #545b62;
        }

        .progress-section {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc143c, #28a745);
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .btn {
            background: #dc143c;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #b22222;
            transform: scale(1.05);
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover {
            background: #545b62;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .btn:disabled:hover {
            background: #6c757d;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            font-size: 16px;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .security-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            border-left: 4px solid #004085;
        }
        .security-title {
            font-size: 16px;
            font-weight: 600;
            color: #004085;
            margin-bottom: 10px;
        }
        .security-text {
            font-size: 14px;
            color: #004085;
            line-height: 1.5;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
        }
        .download-btn {
            display: none;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .download-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .password-input-group {
                flex-direction: column;
                gap: 10px;
            }
            .password-input {
                max-width: none;
            }
            .actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê File Encryption Tool</h1>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('encrypt')">Encrypt File</button>
            <button class="mode-btn" onclick="setMode('decrypt')">Decrypt File</button>
        </div>

        <div class="file-section">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" onchange="handleFileSelect(event)">
                <label for="fileInput" class="file-input-label" id="fileInputLabel">
                    üìÅ Drop a file here or click to select
                </label>
                <div class="file-name" id="fileName">No file selected</div>
                <div class="file-info" id="fileInfo"></div>
            </div>
        </div>

        <div class="password-section">
            <div class="password-title">Password Protection</div>
            <div class="password-input-group">
                <input type="password" class="password-input" id="passwordInput" placeholder="Enter encryption password...">
                <button class="show-password-btn" onclick="togglePasswordVisibility()">Show</button>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <small style="color: #666;">Use a strong password with at least 8 characters</small>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Processing...</div>
        </div>

        <div class="actions">
            <button class="btn success" id="processBtn" onclick="processFile()" disabled>Encrypt File</button>
            <button class="btn secondary" onclick="clearAll()">Clear All</button>
        </div>

        <div class="status-message" id="statusMessage" style="display: none;">
            Status message will appear here
        </div>

        <div class="download-section">
            <button class="download-btn" id="downloadBtn" onclick="downloadFile()">Download Processed File</button>
        </div>

        <div class="security-info">
            <div class="security-title">üîí Security Information</div>
            <div class="security-text">
                ‚Ä¢ Files are encrypted using AES-256 encryption<br>
                ‚Ä¢ Encryption happens entirely in your browser<br>
                ‚Ä¢ Your files and password never leave your device<br>
                ‚Ä¢ Remember your password - lost passwords cannot be recovered<br>
                ‚Ä¢ For maximum security, use a strong, unique password
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let processedFileBlob = null;
        let currentMode = 'encrypt';
        let processing = false;

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const processBtn = document.getElementById('processBtn');
            const fileInputLabel = document.getElementById('fileInputLabel');

            if (mode === 'encrypt') {
                processBtn.textContent = 'Encrypt File';
                fileInputLabel.textContent = 'üìÅ Drop a file here or click to select';
            } else {
                processBtn.textContent = 'Decrypt File';
                fileInputLabel.textContent = 'üìÅ Drop an encrypted file here or click to select';
            }

            updateProcessButton();
            updateStatus('');
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            updateFileDisplay();

            // Reset processed file
            processedFileBlob = null;
            document.getElementById('downloadBtn').style.display = 'none';
        }

        function updateFileDisplay() {
            const fileName = document.getElementById('fileName');
            const fileInfo = document.getElementById('fileInfo');

            if (selectedFile) {
                fileName.textContent = selectedFile.name;
                fileInfo.innerHTML = `
                    Size: ${formatFileSize(selectedFile.size)} |
                    Type: ${selectedFile.type || 'Unknown'} |
                    Modified: ${selectedFile.lastModifiedDate ? selectedFile.lastModifiedDate.toLocaleDateString() : 'Unknown'}
                `;
            } else {
                fileName.textContent = 'No file selected';
                fileInfo.textContent = '';
            }

            updateProcessButton();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            const password = document.getElementById('passwordInput').value;

            const enabled = selectedFile && password.length >= 8 && !processing;
            processBtn.disabled = !enabled;

            if (password.length < 8 && password.length > 0) {
                showStatus('Password must be at least 8 characters long', 'warning');
            } else {
                updateStatus('');
            }
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('passwordInput');
            const showBtn = event.target;

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                showBtn.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                showBtn.textContent = 'Show';
            }
        }

        async function processFile() {
            if (!selectedFile) {
                showStatus('Please select a file', 'error');
                return;
            }

            const password = document.getElementById('passwordInput').value;
            if (password.length < 8) {
                showStatus('Password must be at least 8 characters long', 'error');
                return;
            }

            processing = true;
            updateProcessButton();

            const progressSection = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressSection.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Reading file...';

            try {
                // Read file as ArrayBuffer
                const arrayBuffer = await readFileAsArrayBuffer(selectedFile);
                progressFill.style.width = '30%';
                progressText.textContent = 'Processing file...';

                // Process file based on mode
                if (currentMode === 'encrypt') {
                    processedFileBlob = await encryptFile(arrayBuffer, password);
                    progressText.textContent = 'File encrypted successfully!';
                } else {
                    processedFileBlob = await decryptFile(arrayBuffer, password);
                    progressText.textContent = 'File decrypted successfully!';
                }

                progressFill.style.width = '100%';
                document.getElementById('downloadBtn').style.display = 'inline-block';

                showStatus(`File ${currentMode === 'encrypt' ? 'encrypted' : 'decrypted'} successfully!`, 'success');

                // Track tool usage
                if (window.trackToolUsage) {
                    window.trackToolUsage('file-encryption-tool');
                }

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                processedFileBlob = null;
                document.getElementById('downloadBtn').style.display = 'none';
            } finally {
                setTimeout(() => {
                    progressSection.style.display = 'none';
                }, 2000);
                processing = false;
                updateProcessButton();
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function encryptFile(arrayBuffer, password) {
            if (typeof CryptoJS === 'undefined') {
                throw new Error('CryptoJS library is required for file encryption');
            }

            // Convert ArrayBuffer to WordArray
            const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);

            // Encrypt the file
            const encrypted = CryptoJS.AES.encrypt(wordArray, password);

            // Create a new ArrayBuffer with file metadata + encrypted data
            const encoder = new TextEncoder();
            const fileNameBytes = encoder.encode(selectedFile.name);
            const encryptedString = encrypted.toString();

            // Format: [fileNameLength(4 bytes)] + [fileName] + [encryptedData]
            const fileNameLength = new Uint32Array([fileNameBytes.length]);
            const encryptedBytes = encoder.encode(encryptedString);

            const totalLength = 4 + fileNameBytes.length + encryptedBytes.length;
            const resultBuffer = new Uint8Array(totalLength);

            // Write file name length (4 bytes)
            resultBuffer.set(new Uint8Array(fileNameLength.buffer), 0);

            // Write file name
            resultBuffer.set(fileNameBytes, 4);

            // Write encrypted data
            resultBuffer.set(encryptedBytes, 4 + fileNameBytes.length);

            return new Blob([resultBuffer], { type: 'application/octet-stream' });
        }

        async function decryptFile(arrayBuffer, password) {
            if (typeof CryptoJS === 'undefined') {
                throw new Error('CryptoJS library is required for file decryption');
            }

            try {
                const data = new Uint8Array(arrayBuffer);

                // Read file name length (first 4 bytes)
                const fileNameLength = new Uint32Array(data.slice(0, 4).buffer)[0];

                // Read file name
                const fileNameBytes = data.slice(4, 4 + fileNameLength);
                const decoder = new TextDecoder();
                const originalFileName = decoder.decode(fileNameBytes);

                // Read encrypted data
                const encryptedBytes = data.slice(4 + fileNameLength);
                const encryptedString = decoder.decode(encryptedBytes);

                // Decrypt the data
                const decrypted = CryptoJS.AES.decrypt(encryptedString, password);
                const decryptedWordArray = decrypted;

                // Convert back to ArrayBuffer
                const decryptedArrayBuffer = wordArrayToArrayBuffer(decryptedWordArray);

                return new Blob([decryptedArrayBuffer], { type: 'application/octet-stream' });

            } catch (error) {
                throw new Error('Invalid encrypted file or password');
            }
        }

        function wordArrayToArrayBuffer(wordArray) {
            const arrayOfWords = wordArray.hasOwnProperty('words') ? wordArray.words : [];
            const length = wordArray.hasOwnProperty('sigBytes') ? wordArray.sigBytes : arrayOfWords.length * 4;
            const uInt8Array = new Uint8Array(length);
            let index = 0;
            let word;
            let i;

            for (i = 0; i < length; i++) {
                word = arrayOfWords[i];
                uInt8Array[index++] = word >> 24;
                uInt8Array[index++] = (word >> 16) & 0xff;
                uInt8Array[index++] = (word >> 8) & 0xff;
                uInt8Array[index++] = word & 0xff;
            }

            return uInt8Array.buffer.slice(0, length);
        }

        function downloadFile() {
            if (!processedFileBlob) {
                alert('No processed file available');
                return;
            }

            const url = URL.createObjectURL(processedFileBlob);
            const a = document.createElement('a');
            a.href = url;

            // Generate filename based on mode
            const originalName = selectedFile.name;
            const baseName = originalName.replace(/\.[^/.]+$/, ''); // Remove extension
            const extension = originalName.split('.').pop();

            let newFileName;
            if (currentMode === 'encrypt') {
                newFileName = `${baseName}_encrypted.${extension}`;
            } else {
                newFileName = `${baseName}_decrypted.${extension}`;
            }

            a.download = newFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus(`File downloaded as: ${newFileName}`, 'success');
        }

        function clearAll() {
            selectedFile = null;
            processedFileBlob = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('passwordInput').value = '';
            updateFileDisplay();
            document.getElementById('downloadBtn').style.display = 'none';
            updateStatus('');
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';

            if (type) {
                statusElement.classList.add('status-' + type);
            }

            statusElement.style.display = message ? 'block' : 'none';
        }

        function updateStatus(message) {
            showStatus(message, message ? 'info' : '');
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', () => {
            const fileInputLabel = document.getElementById('fileInputLabel');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileInputLabel.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                fileInputLabel.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileInputLabel.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                fileInputLabel.classList.add('drag-over');
            }

            function unhighlight(e) {
                fileInputLabel.classList.remove('drag-over');
            }

            fileInputLabel.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    selectedFile = files[0];
                    updateFileDisplay();

                    // Reset processed file
                    processedFileBlob = null;
                    document.getElementById('downloadBtn').style.display = 'none';
                }
            }
        });

        // Update process button when password changes
        document.getElementById('passwordInput').addEventListener('input', updateProcessButton);
    </script>

    <!-- Load crypto-js for AES encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</body>
</html>